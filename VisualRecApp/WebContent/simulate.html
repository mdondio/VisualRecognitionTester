<!DOCTYPE html>
<html>

<head></head>

<!-- Main inclusions -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
<!-- Functions -->
<script src="js/genericFunctions.js"></script>
<script src="js/functions.js"></script>
<!-- Carbon design scripts -->
<script src="js/index.js"></script>
<script src="js/bluemix-components.min.js"></script>
<script src="js/svgxuse.min.js"></script>
<!-- Utilities -->
<script src="js/jquery.lazy.min.js"></script>
<script src="js/tingle.min.js"></script>
<script src="js/progressbar.js"></script>
<script src="js/circle.js"></script>
<!-- <script src="js/tingle.min.js"></script> -->
<link rel="stylesheet" href="css/tingle.min.css">

<script>
createHead();
createCarbonHeader();
</script>

<body>
		
<div id="carbon-header"></div>
				
<br><br><br>
  
<div class="content" id="simulate">

	<div class="row clearfix">

		<div class="column fourth"><h1>Simulate</h1>
		</div>
	</div>
	
	<div class="row clearfix">

		<div class="column third"><h1>&ensp;</h1><strong class="bx--label">Add tests</strong><br>
			You can run 10 test at the same time
		</div>
		
		<div class="column third"><h1>&ensp;</h1><strong class="bx--label">Upload a new image set</strong><br>
			Select positive and negative images to test Watson
		</div>
		
		<div class="column third"><h1>&ensp;</h1><strong class="bx--label">Run simulation</strong><br>
			When you are ready start the simulation with Watson
		</div>

	</div>

 	<br>
 
    <div class="row clearfix">
    	<div class="column full">
    	
				<form id="myForm" action="javascript:startSimulation();">
					<br>
					<hr class="lineseparator">
					
					<div style="text-align:center;">
						<button id="addicon" class="bx--btn bx--btn--secondary" type="button">
						  Add test
						  <svg class="bx--btn__icon">
						    <use xlink:href="./ico/bluemix-icons.svg#icon--add--glyph"></use>
						  </svg>
						</button>
						<button id="uploadicon" class="bx--btn bx--btn--secondary" type="button">
						  Upload image set
						  <svg class="bx--btn__icon">
						    <use xlink:href="./ico/bluemix-icons.svg#icon--upload"></use>
						  </svg>
						</button>
						<button id="playicon" class="bx--btn bx--btn--primary" type="submit">Run simulation</button>
					</div>
					
					<hr class="lineseparator">
					<br>

					<div class="row clearfix moltiplicandum" id="moltiplicandum1" style="margin-bottom: 20px; margin-left: 200px;">

						<div class="column fourth">						
								<div class="bx--form-item">
								  <input id="testname1" type="text" class="bx--text-input" placeholder="TEST_1" required>
								</div>	
						</div>						
						
						<div class="column fourth">
								<div class="bx--form-item">
								  <div class="bx--select">
								    <select id="testset1" class="bx--select-input" required>
								      <option class="bx--select-option" disabled selected hidden value="">Select test set</option>
								    </select>
								    <svg class="bx--select__arrow">
								      <use xlink:href="./ico/bluemix-icons.svg#icon--caret--down"></use>
								    </svg>
								  </div>
								</div>
						</div>
							
						<div class="column fourth">			
								<div class="bx--form-item">
								  <div class="bx--select">
								    <select id="testclassifier1" class="bx--select-input" required>
								      <option class="bx--select-option" disabled selected hidden value="">Select classifier</option>
								    </select>
								    <svg class="bx--select__arrow">
								      <use xlink:href="./ico/bluemix-icons.svg#icon--caret--down"></use>
								    </svg>
								  </div>
								</div>
						</div>
						
						<div class="column fourth">
								<img id="reload1" data-alt-src="ico/reload.png" src="ico/reloadDARK.png" style="width:40px;height:auto;margin-left:15px;margin-right:15px;">
								<img id="garbage1" data-alt-src="ico/garbage.png" src="ico/garbageDARK.png" style="width:40px;height:auto;margin-left:15px;margin-right:15px;">
						</div>
						
					</div>
				</form>
				
      </div>
    </div>
    
  </div>
  
<!--   ================================================================ -->
<!--   ====================== WAITING LOGO ============================ -->
<!--   ================================================================ -->
  
  <!-- Icona Watson -->
<!--    	<div class="content" id="waiting" style="display:none;"> -->
<!-- 		<img src='ico/load.svg' id="logowait waiting" style="display: none"> -->
		<img src='ico/load.svg' id="waiting" style="display: none;">
<!-- 	</div> -->
		
<!--   ================================================================ -->
<!--   ====================== SHOW PAGE =============================== -->
<!--   ================================================================ -->

	<div class="content" id="showtest" style="display: none;">
	
	
		<div class="row clearfix">
			
			<div class="column fourth"><h1>Test results</h1><br><br>
			
<!-- 			<select id="testset1" class="bx--select-input" required> -->
<!-- 			      <option class="bx--select-option" disabled selected hidden value="">Select test set</option> -->
<!-- 			</select> -->
			
			<div class="row clearfix">
				<div class="column full">
					<select id="show_test" class="bx--select-input">
						<option class="bx--select-option" disabled selected hidden value="">Select test</option>
					</select>
					<br><br>
					<div style="text-align:center;">
						<button class="bx--btn bx--btn--primary" id="saveJSON" type="sumbit">Download JSON</button>
						<button class="bx--btn bx--btn--primary" id="saveJSONDB" type="sumbit">Save to DB</button>
					</div>
				</div>
			</div>
		<hr class="lineseparator">
		
			<div class="row clearfix selecttest" style="">
				<br><br><br><center>Select a test to view results</center>
			</div>
		
			<div class="row clearfix displayresults" style="display: none;">

				<div class="column half">
					<div class="post-preview" style="width: 100%; height: auto">
						<div class="progressbar" id="accuracyscore"></div>
						<center><strong class="bx--label">Accuracy</strong></center>
					</div>
					<br>
					<div class="post-preview" style="width: 100%; height: auto">
						<div class="progressbar" id="thresholdscore"></div>
						<center><strong class="bx--label">Threshold</strong></center>
					</div>
				</div>

				<div class="column half">
					<div class="post-preview" style="width: 100%; height: auto">
						<div class="progressbar" id="aucscore"></div>
						<center><strong class="bx--label">AUC</strong></center>
					</div>
					<br>

				</div>
				
			</div>
				
		</div>
			
				<div class="column three-fourths">
				
	
					<nav data-tabs class="bx--tabs" role="navigation">
					
						  <div class="bx--tabs-trigger" tabindex="0">
						    <a href="javascript:void(0)" class="bx--tabs-trigger-text" tabindex="-1"></a>

						  </div>
						  
						  <ul class="bx--tabs__nav bx--tabs__nav--hidden" role="tablist">
						    <li class="bx--tabs__nav-item bx--tabs__nav-item--selected" data-target=".tab-1" role="presentation">
						      <a id="tab-link-1" class="bx--tabs__nav-link" href="javascript:void(0)" role="tab" aria-controls="tab-panel-1" aria-selected="true">Selected test results</a>
						    </li>
						    <li class="bx--tabs__nav-item" data-target=".tab-3" role="presentation">
						      <a id="tab-link-3" class="bx--tabs__nav-link" href="javascript:void(0)" role="tab" aria-controls="tab-panel-3" aria-selected="false">Overview of all tests</a>
						    </li>
						  </ul>
						  
					</nav>
					
					<div style="padding: 1rem;"> 
					  <div id="tab-panel-1" class="tab-1" role="tabpanel" aria-labelledby="tab-link-1" aria-hidden="false">
					  	<div class="row clearfix">
					  		<div class="column half"><strong class="bx--label">ROC curve</strong><div id="graph1"></div></div>
					  		<div class="column half">
					  			<strong class="bx--label">Distribution</strong>
					  			
					  			<a class="bx--tooltip__trigger">
								  <svg tabindex="0" data-tooltip-trigger data-tooltip-target="#unique-tooltip" width="16" height="16">
								    <use xlink:href="./ico/bluemix-icons.svg#icon--info--glyph"></use>
								  </svg>
								</a>
								<div id="unique-tooltip" data-floating-menu-direction="top" class="bx--tooltip">
								  <p class="bx--tooltip__label">Distribution graph</p>
								  <p>Thanks to Visual Recognition scores, we can draw the negative and the positive distribution curves. Classifier effectiveness increases if VR instance is able to better separate the positive population from the negative one.</p>
								</div>
					  			<div class="selecttest"><br><br><br>Select a test to view distribution graph</div>		
					  			<div class="displayresults" id="graph_histogram"></div>
					  		</div>
					  		
					  	</div>
					    
					  </div>
					  <div id="tab-panel-3" class="tab-3" role="tabpanel" aria-labelledby="tab-link-3" aria-hidden="true" hidden>
					    <div id="graph2"></div>
					  </div>

					</div>
				
				
				
				</div>
		
		</div>
		
		<br><br>
		
		<div class="row clearfix">
	
			<div class="column half">
				<strong class="bx--label">False positive</strong>
				<p class="bx--label-description">Images wrongly recognized as part of the category</p>
				<hr class="lineseparator">
				<div id="galleryFP"></div>
			</div>
	
			<div class="column half">
				<strong class="bx--label">False negatives</strong>
				<p class="bx--label-description">Images not recognized as part of the category</p>
				<hr class="lineseparator">
				<div id="galleryFN"></div>
			</div>
			
		</div>
		

	</div>


</body>





<script>


$( document ).ready(function() {

if(localStorage.getItem("viewresult")=="history")
{
localStorage.setItem("viewresult", "simulation");
//mostro subito la parte di show
$("#simulate").hide();
$("#showtest").show("slow");
buildSelectTestResult('#show_test');
updateTestFields('#show_test');
}
});

//=========================== Simulate part ===================

//ADD button actions
$('#addicon').mouseover(function(){
	$(this).attr('src','ico/addicon.png');
});

$('#addicon').mouseleave(function(){
	$(this).attr('src',"ico/addDARK.png" );
});

var TOTALROWSFILLED = 1;
$('#addicon').click(function(){
if(TOTALROWSFILLED < 10){
      var $div = $('div[id^="moltiplicandum"]:last'); // seleziono l'ultimo moltiplicandum
      var nextrow = parseInt( $div.prop("id").match(/\d+/g), 10 ) +1; // estraggo il numero identificativo e lo incremento
      var currentrow = nextrow-1;       
      $("#moltiplicandum"+currentrow).clone().prop('id', 'moltiplicandum'+nextrow).appendTo("#myForm"); // clono, rinomino e appendo
      $("#moltiplicandum"+nextrow).find('input:text').val("TEST_"+nextrow);
      $("#moltiplicandum"+nextrow).find("input#testname"+currentrow).attr("id","testname"+nextrow);
      $("#moltiplicandum"+nextrow).find("select#testset"+currentrow).attr("id","testset"+nextrow);
      $("#moltiplicandum"+nextrow).find("select#testclassifier"+currentrow).attr("id","testclassifier"+nextrow);
      $("#moltiplicandum"+nextrow).find("img#reload"+currentrow).attr("id","reload"+nextrow);
      $("#moltiplicandum"+nextrow).find("img#garbage"+currentrow).attr("id","garbage"+nextrow);
    } else {
    swal({
				title: "Warning",
				text: "Max number of entries reached. You can run max 10 tests simultaneously.",
				type: "warning"});
    }
    TOTALROWSFILLED++;
});

//UPLOAD button actions
$('#uploadicon').mouseover(function(){
	$(this).attr('src','ico/upload.png');
});

$('#uploadicon').mouseleave(function(){
	$(this).attr('src',"ico/uploadDARK.png" );
});

$('#uploadicon').click(function(){
	//forcing page change without checking for correct test insertions
	document.location.href = 'upload.html';
});

//PLAY button actions
$('#playicon').mouseover(function(){
	$(this).attr('src','ico/play-button.png');
});

$('#playicon').mouseleave(function(){
	$(this).attr('src',"ico/play-buttonDARK.png" );
});

//RELOAD button actions
$('body').on("mouseover","img[id*=reload]",function(){
 	$(this).attr('src',"ico/reload.png");
});

$('body').on("mouseleave","img[id*=reload]",function(){
 	$(this).attr('src',"ico/reloadDARK.png");
});

$('body').on("click","img[id*=reload]",function(){
	var $this = $(this);
	var num = parseInt($this.prop("id").substring(6));
  	$("#moltiplicandum"+num).find('input:text').val("TEST_"+num);
 	$("#moltiplicandum"+num).find('select').val("").find('select').val("");      
});

//GARBAGE button actions
$('body').on("mouseover","img[id*=garbage]",function(){
 	$(this).attr('src',"ico/garbage.png");
});

$('body').on("mouseleave","img[id*=garbage]",function(){
 	$(this).attr('src',"ico/garbageDARK.png");
});

$('body').on("click","img[id*=garbage]",function(){
	var $this = $(this);
	var num = parseInt($this.prop("id").substring(7));
	var size = Array.prototype.map.call($(".moltiplicandum input"),(function(el){return el.value;}));
	if(size.length>1) 
	{
	$("#moltiplicandum"+num).remove();
		TOTALROWSFILLED--;
	}
	else swal({
				title: "Warning",
				text: "You have to run at least one test",
				type: "warning"});
});

//WARNING overlap images between test dataset and classifier dataset
$('body').on("change","select[id*=testset]",function(){
 	var $this = $(this);
	var num = parseInt($this.prop("id").substring(7));
	
	var IDdataset = $("#testset"+num).val();
	var IDclassifier = $("#testclassifier"+num).val();
	
	console.log("ID dataset= "+IDdataset);
	console.log("ID classifier= "+IDclassifier);
		
	if(IDclassifier != null)
	{

		$.ajax({
		contentType: "application/json",
		dataType: "json",
		url: 'CheckOverlapImages',
		data : "dataset="+IDdataset+"&classifier="+IDclassifier,
		async: false,
		success: function(result){
		if(result.hasOwnProperty('error'))
				{
				swal({
					title: 'Warning',
					text: result.error,
					type: 'warning',});
				}
			else{
			console.log(result.images);
						console.log(result.size);
			if(result.size>0){
			swal({
				title: "Warning",
				text: "This test-dataset shares "+result.size+" images with this training-classifier dataset",
				type: "warning"});
				}
				}
				}});
		}
	});

$('body').on("change","select[id*=testclassifier]",function(){
 	 	var $this = $(this);
	var num = parseInt($this.prop("id").substring(14));
	
	var IDdataset = $("#testset"+num).val();
	var IDclassifier = $("#testclassifier"+num).val();
	
	console.log("ID dataset= "+IDdataset);
	console.log("ID classifier= "+IDclassifier);
		
	if(IDdataset != null)
	{

		$.ajax({
		contentType: "application/json",
		dataType: "json",
		url: 'CheckOverlapImages',
		data : "dataset="+IDdataset+"&classifier="+IDclassifier,
		async: true,
		success: function(result){
		if(result.hasOwnProperty('error'))
				{
				swal({
					title: 'Warning',
					text: result.error,
					type: 'warning',});
				}
			else{
			console.log(result.images);
						console.log(result.size);
			if(result.size>0){
			swal({
				title: "Warning",
				text: "This test-dataset shares "+result.size+" images with this training-classifier dataset",
				type: "warning"});
				}
				}
				}});
		}
});

//=========================== Showresult part ===================

// ON CHANGE select test SHOW SIDE
	$('#show_test').on(
			'change',
			function() {
			updateTestFields('#show_test');
			
			$('.selecttest').css("display", "none");
			$('.displayresults').css("display", "block");
			
			$('#accuracyscore').empty();
			$('#aucscore').empty();
			$('#thresholdscore').empty();			
			
			createProgress(accuracyscore, '#3d70b2', getAccuracy());
			createProgress(aucscore, '#41d6c3', getAUC());
			createProgress(thresholdscore, '#5596e6', getTreshold());
// 			createProgress(indice, '#8c9ba5', '0');
});   

$('#saveJSON').click(function(){

	//openModal2();
	createMyModal();

});

$('#saveJSONDB').click(function(){
 			swal({
 			
				title: "Warning",
				text: "We are working hard on this feature... just relax and run a new simulation.",
				type: "warning"});
				
				});
				
</script>

<script>
buildSelectDataSet("test_set",'[id*="testset"]');
buildSelectClassifier("ready",'[id*="testclassifier"]');
</script>

</html>
